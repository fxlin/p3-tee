
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Quickstart: OPTEE - p3-tee</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="orange">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#quickstart-optee" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="p3-tee" class="md-header__button md-logo" aria-label="p3-tee" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            p3-tee
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Quickstart: OPTEE
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../quickstart/" class="md-tabs__link">
      quickstart
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../helloworld/" class="md-tabs__link">
      app samples
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../secure-vision/" class="md-tabs__link">
      task
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../issues/" class="md-tabs__link">
      troubleshoot
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../porting/" class="md-tabs__link">
      /porting
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../cleanup/" class="md-tabs__link">
      /cleanup
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../sod/" class="md-tabs__link">
      /lib
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="p3-tee" class="md-nav__button md-logo" aria-label="p3-tee" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    p3-tee
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        quickstart
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../helloworld/" class="md-nav__link">
        app samples
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../secure-vision/" class="md-nav__link">
        task
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../issues/" class="md-nav__link">
        troubleshoot
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../porting/" class="md-nav__link">
        /porting
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../cleanup/" class="md-nav__link">
        /cleanup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../sod/" class="md-nav__link">
        /lib
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#source-code-overview" class="md-nav__link">
    Source code overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-entire-project-an-overview" class="md-nav__link">
    Building the entire project: an overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-steps" class="md-nav__link">
    Setup steps
  </a>
  
    <nav class="md-nav" aria-label="Setup steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-prep-personal-machine" class="md-nav__link">
    Step 1: Prep personal machine
  </a>
  
    <nav class="md-nav" aria-label="Step 1: Prep personal machine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-make-your-choice" class="md-nav__link">
    1.1. Make your choice:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-install-software" class="md-nav__link">
    1.2 Install Software
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-build-op-tee-for-qemu" class="md-nav__link">
    Step 2: build OP-TEE for QEMU
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-run-optee" class="md-nav__link">
    Step 3: run OPTEE
  </a>
  
    <nav class="md-nav" aria-label="Step 3: run OPTEE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#troubleshoot" class="md-nav__link">
    Troubleshoot
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#results" class="md-nav__link">
    Results
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-you-cannot-get-local-x-server-to-work" class="md-nav__link">
    If you cannot get local X server to work
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-apps" class="md-nav__link">
    Test apps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-workflow" class="md-nav__link">
    Development workflow
  </a>
  
    <nav class="md-nav" aria-label="Development workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choice-1-easier-to-set-up-but-need-to-reboot-qemu-every-time" class="md-nav__link">
    Choice 1: easier to set up (but need to reboot QEMU every time)
  </a>
  
    <nav class="md-nav" aria-label="Choice 1: easier to set up (but need to reboot QEMU every time)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-ca-the-normal-world" class="md-nav__link">
    1. CA (the normal world):
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-ta-the-secure-world" class="md-nav__link">
    2. TA (the secure world)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choice-2-shared-binaries-with-qemu-no-reboot-needed" class="md-nav__link">
    Choice 2: shared binaries with QEMU, no reboot needed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choice-3-rpi3-copying-files-over-ssh" class="md-nav__link">
    Choice 3: Rpi3 - copying files over SSH
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="quickstart-optee">Quickstart: OPTEE</h1>
<p><strong>This project is to be completed on servers; or your own Linux/Windows box; or rpi3</strong></p>
<h2 id="source-code-overview">Source code overview</h2>
<p>Compared to the codebase we have dealt with before, OPTEE is a complex project with a myriad of components, including QEMU, a normal world daemon, trustlets (TAs), etc. The sources of all these components are organized in a directory with the following structure. </p>
<pre><code>($optee ROOT)
├── build (this is where we execute the build command)
    ├── shared_folder/ (will be shared with the QEMU)
    ├── (other artifacts)
├── buildroot
├── edk2 (a firmware SDK)
├── linux
├── mbedtls
├── optee_benchmark
├── optee_client
├── optee_examples
├── optee_os
├── optee_test
├── out
├── out-br (the build outcome)
├── qemu (a qemu version with TrustZone support)
├── soc_term
├── toolchains
└── trusted-firmware-a
</code></pre>
<p>The build process is complex. It is managed by numerous Makefiles in a hierarchy; it also builds for various Arm boards and QEMU (called "targets''). To automate the build process, there is a dedicated component called <code>build</code> (see above), which has its own git repository. </p>
<h2 id="building-the-entire-project-an-overview">Building the entire project: an overview</h2>
<ol>
<li>Grab the source code:<ol>
<li>Access the tarball (optee-qemuv8-students-MMDDYY.tar) from /home/students/ on granger1/2. <strong>Don't need to copy to your home dir</strong>. Directly untar it like <code>cd ~/; tar xvf /home/students/optee-qemuv8-students.tar</code>.</li>
<li>If you use own machine, you can download the tarball over SSH.        </li>
</ol>
</li>
<li>First time build: we will build everything including QEMU and normal/secure worlds binaries of OPTEE. The build process will pack these binaries into an OS image (rootfs image) to be launched by QEMU</li>
<li>Run QEMU and play with "Hello world", validating that our environment works properly.</li>
<li>Repeated build: modify source code of normal world app and TAs, and build again. </li>
</ol>
<h2 id="setup-steps">Setup steps</h2>
<p>Most students may develop an ARM platform with TrustZone as emulated by QEMU. For students who want to use real hardware (Rpi3), see <a href="quickstart-rpi3.md">here</a>. </p>
<p><strong>DO NOT REUSE QEMU FROM P1. MUST BUILD FROM SOURCE CODE.</strong></p>
<h3 id="step-1-prep-personal-machine">Step 1: Prep personal machine</h3>
<p>Below, </p>
<p>"owner" == you have a local machine with admin access</p>
<p>"unsupported" == it may work; but course staff cannot provide support</p>
<h4 id="11-make-your-choice">1.1. Make your choice:</h4>
<ol>
<li><strong>Local build choice: (Recommended for Win/Linux owners)</strong>. Must run Ubuntu 20.04; 50GB disk space. Pros: code builds fast; nice xterm. </li>
<li><strong>Remote build choice: (possible to Win/Linux/Mac)</strong>. Personal machine connected to course servers; build everything on servers. </li>
</ol>
<h4 id="12-install-software">1.2 Install Software</h4>
<ul>
<li>
<p>Local build choice:</p>
<ul>
<li>Win owner: Install WSL2 <a href="https://docs.google.com/document/d/1EseVrjfDBpFcz5_TETV7HQXRptpMQO6MJoI2Qq7vB2E/edit?usp=sharing">instructions</a>. Install Ubuntu == 20.04. Install software dependencies <a href="quickstart-req.md">here</a>.</li>
<li>Linux owner: Install software dependencies <a href="quickstart-req.md">here</a>.</li>
</ul>
</li>
<li>
<p>Remote build choice: </p>
<ul>
<li>Win owner: Install WSL2 <a href="https://docs.google.com/document/d/1EseVrjfDBpFcz5_TETV7HQXRptpMQO6MJoI2Qq7vB2E/edit?usp=sharing">instructions</a>. Can do with Ubuntu &gt;= 20.04</li>
<li>Linux owner: make sure you have a local X desktop. </li>
<li>Mac owner: Install &amp; configure X server. <a href="https://docs.google.com/document/d/1MVOJzVWuJeYznnzXg1C6Pe6bLi1KlmXik2FiPB1mKlE/edit?usp=sharing">instructions</a></li>
</ul>
</li>
</ul>
<h3 id="step-2-build-op-tee-for-qemu">Step 2: build OP-TEE for QEMU</h3>
<p>The following instructions assume <code>${OPTEE}</code> to be the top directory, e.g. <code>~/optee_qemuv8</code> </p>
<p><strong>(Apr 2023)</strong>: update the two newest files (executed once) </p>
<pre><code class="language-bash">cd ${OPTEE}
wget https://raw.githubusercontent.com/fxlin/p3-tee/master/env.sh
cd build
mv qemu_v8.mk qemu_v8.mk.orig
wget https://raw.githubusercontent.com/fxlin/p3-tee/master/qemu_v8.mk
</code></pre>
<p>Every time you log in: </p>
<pre><code class="language-bash">$ cd ${OPTEE}
$ source env.sh  # will load commands, gen random ports, etc.
</code></pre>
<p>Build OPTEE for QEMU ARMv8: </p>
<pre><code class="language-sh">$ cd ${OPTEE}/build
# clean build: about 5 minutes on a 20-core machine. Can be longer if other users exist
$ make QEMU_VIRTFS_ENABLE=y CFG_SECURE_DATA_PATH=y CFG_TEE_RAM_VA_SIZE=0x00300000 -j`nproc`
</code></pre>
<p>Or just type <code>p3-build-all</code> which runs the above command.</p>
<p><strong>Explanation</strong>: QEMU_VIRTFS_ENABLE allows QEMU and the host (e.g. granger1) to share files; CFG_SECURE_DATA_PATH builds in the support for data copy between two worlds; CFG_TEE_RAM_VA_SIZE sets the virtual address range for TEE; -j<code>nproc</code> asks to use all cores for making. </p>
<p>If you want to clean up existing build, do <code>cd build &amp;&amp; make clean</code>. To further cleans up configuration files, do <code>cd build &amp;&amp; make cleaner</code>. </p>
<h3 id="step-3-run-optee">Step 3: run OPTEE</h3>
<pre><code class="language-sh">cd build
make run-only QEMU_VIRTFS_ENABLE=y QEMU_VIRTFS_HOST_DIR=`readlink -f shared_folder`
</code></pre>
<p>Or just type <code>p3-run</code> which runs the above command.</p>
<p><strong>Explanation</strong>: QEMU_VIRTFS_HOST_DIR means the emulated OS and server (e.g. gr1/2) will share a directory. Easy for file exchange. </p>
<p>QEMU must be launched without errors. In case of errors, see <a href="issues.md">troubleshooting</a>.</p>
<p>Start the emulation: typing <code>c</code> in the QEMU console. There might be delay of 1-2 secs because of the Internet communication, but the overall experience is good.</p>
<h5 id="troubleshoot">Troubleshoot</h5>
<p>If the port is already in use, "make run-only" may just hang (likely b/c xterm hangs) with no output. If that happens, use <code>netstat</code> to verify and try an unused one (<code>p3-gen-ranom-ports</code>).</p>
<h3 id="results">Results</h3>
<p>WSL2: </p>
<p><img alt="" src="wsl-xterm.png" /></p>
<p>Mac: </p>
<p><img alt="img" src="4-_pohrywkT4meL6-tUb4Wu7ynU1qFBQGLbQ7elcD801GejotXQIbnti6wfDjqiaKAVirY6R4tPA9wyiTQYgwaGwUgiias8VRDUY4TDYn9YdrAOrn5KLWpR8yLAmqTX4zwRjudu6rh0Ax7M7WdxBAyk.png" /></p>
<h3 id="if-you-cannot-get-local-x-server-to-work">If you cannot get local X server to work</h3>
<p>Run nc on server. See <a href="quickstart-nc.md">quickstart-nc.md</a>.</p>
<h2 id="test-apps">Test apps</h2>
<p>Verify that OPTEE's normal-world daemon (<code>tee_supplicant</code>) is already started automatically as a service.</p>
<pre><code class="language-bash"># In the normal world console: 
$ ps aux|grep supplicant
 190 tee      /usr/sbin/tee-supplicant -d /dev/teepriv0b
</code></pre>
<p>Run OPTEE's test suite (<code>xtest</code>), which should have already been baked in the rootfs image in the build process: </p>
<pre><code class="language-bash"># In the normal world console: 
$ which xtest
/usr/bin/xtest
$ xtest
(output...)
</code></pre>
<p>For more options for <code>xtest</code>, see its <a href="https://optee.readthedocs.io/en/latest/building/gits/optee_test.html#optee-test-run-xtest">reference</a></p>
<p>Now try examples for OPTEE, e.g. </p>
<pre><code class="language-bash">#  In the normal world console: 
$ optee_example_hello_world
Invoking TA to increment 42
TA incremented value to 43
</code></pre>
<p>Reference: <a href="https://optee.readthedocs.io/en/latest/building/gits/build.html#root-fs">Official build instructions</a></p>
<h2 id="development-workflow">Development workflow</h2>
<h3 id="choice-1-easier-to-set-up-but-need-to-reboot-qemu-every-time">Choice 1: easier to set up (but need to reboot QEMU every time)</h3>
<p>We will leverage an existing OPTEE example program: modify/add/delete its sources, rebuild the entire rootfs, and relaunch QEMU. In this way, we do not have deal with the Makefile hierarchy. </p>
<p>We pick the "helloworld" example. Here's its source directory: </p>
<pre><code class="language-bash">$ tree ./optee_examples/hello_world/
hello_world/
├── Android.mk
├── CMakeLists.txt
├── host (the normal world)
│   ├── main.c
│   └── Makefile
├── Makefile
└── ta (the secure world)
    ├── Android.mk
    ├── hello_world_ta.c
    ├── include
    │   └── hello_world_ta.h
    ├── Makefile
    ├── sub.mk
    └── user_ta_header_defines.h
3 directories, 11 files

</code></pre>
<h4 id="1-ca-the-normal-world">1. CA (the normal world):</h4>
<p>Let's do some trivial changes to the helloworld app source: </p>
<p>./optee_examples/hello_world/host/main.c</p>
<pre><code class="language-c">@@ -82,7 +82,7 @@ int main(void)
         * TA_HELLO_WORLD_CMD_INC_VALUE is the actual function in the TA to be
         * called.
         */
-       printf(&quot;Invoking TA to increment %d\n&quot;, op.params[0].value.a);
+       printf(&quot;hello! ... Invoking TA to increment %d\n&quot;, op.params[0].value.a);
+       
</code></pre>
<p>Then rebulid hello world: </p>
<pre><code class="language-bash"># on dev machine:
$ cd ${OPTEE}/build    
$ make buildroot QEMU_VIRTFS_ENABLE=y CFG_SECURE_DATA_PATH=y CFG_TEE_RAM_VA_SIZE=0x00300000 -j`nproc`
</code></pre>
<p>Explanation: the "buildroot" target is for the entire filesystem, including CA/TA programs within. Note that <code>make optee-examples-common</code> seems obsoleted. See <a href="https://github.com/OP-TEE/build/issues/282">discussion</a>.</p>
<p>Output location: <code>./out-br/target/usr/bin/optee_example_hello_world</code></p>
<p>Restart QEMU and invoke the CA  from within QEMU, showing that our modification is effective: </p>
<pre><code class="language-bash"># (in the normal world console)
$ optee_example_hello_world
hello! ... Invoking TA to increment 42
TA incremented value to 43
</code></pre>
<h4 id="2-ta-the-secure-world">2. TA (the secure world)</h4>
<p>Source location: <code>./optee_examples/hello_world/ta/hello_world_ta.c</code> </p>
<p>Do some trivial changes: </p>
<pre><code class="language-c">@@ -108,7 +108,8 @@ static TEE_Result inc_value(uint32_t param_types,
                return TEE_ERROR_BAD_PARAMETERS;

        IMSG(&quot;Got value: %u from NW&quot;, params[0].value.a);
-       params[0].value.a++;
+       params[0].value.a+=2;
        IMSG(&quot;Increase value to: %u&quot;, params[0].value.a);
</code></pre>
<p>Build: </p>
<pre><code class="language-bash"># On dev machine
$ cd ${OPTEE}/build    
$ make buildroot QEMU_VIRTFS_ENABLE=y CFG_SECURE_DATA_PATH=y CFG_TEE_RAM_VA_SIZE=0x00300000 -j`nproc`
</code></pre>
<p>Check the build outcome: </p>
<pre><code class="language-bash"># on dev machine
# cd ${OPTEE}
$ ls -lh out-br/target/lib/optee_armtz/8aaaf200-2450-11e4-abe2-0002a5d5c51b.ta
-r--r--r-- 1 xzl xzl 55K Jul 10 09:56 out-br/target/lib/optee_armtz/8aaaf200-2450-11e4-abe2-0002a5d5c51b.ta

$ md5sum out-br/target/lib/optee_armtz/8aaaf200-2450-11e4-abe2-0002a5d5c51b.ta
669e219e7381c842d80f3ba68db9368f  out-br/target/lib/optee_armtz/8aaaf200-2450-11e4-abe2-0002a5d5c51b.ta
</code></pre>
<p>Why the magical filename? This is because each TA is named after a unique UUID. In this example, it is defined in <code>hello_world_ta.h</code>. The build script will pick the UUID up and name the output binary after it. </p>
<p>Restart QEMU, and check if the newly build TA is baked into our rootfs: </p>
<pre><code class="language-bash"># (In the normal world console): 
$ md5sum /lib/optee_armtz/8aaaf200-2450-11e4-abe2-0002a5d5c51b.ta
669e219e7381c842d80f3ba68db9368f
</code></pre>
<p>The md5sum (669e2...) matches what we saw above. </p>
<p>Now run helloworld again: </p>
<pre><code class="language-bash"># (in the normal world console)
$ optee_example_hello_world
hello! ... Invoking TA to increment 42
TA incremented value to 44
</code></pre>
<p>The value is incremented by 2 -- our modification to TA works!</p>
<h3 id="choice-2-shared-binaries-with-qemu-no-reboot-needed">Choice 2: shared binaries with QEMU, no reboot needed</h3>
<p>With the above method, you will soon find it tedious to restart QEMU every time we change TA/CA sources. The solution is to share the TA/CA build outcome via a folder shared with the QEMU guest.</p>
<p><strong>0.Prep</strong></p>
<p>On the development machine, from the root of OPTEE source code (sp23: already done by TA): </p>
<pre><code class="language-sh">$ mkdir -p build/shared_folder
</code></pre>
<p>When we build &amp; launch QEMU, make sure to pass in "VIRTFS" (virtual filesystem) arguments: </p>
<pre><code class="language-bash">$ make run-only QEMU_VIRTFS_ENABLE=y QEMU_VIRTFS_HOST_DIR=build/shared_folder
</code></pre>
<p>After QEMU is launched, Linux mounts the shared folder in QEMU guest system automatically. To verify: </p>
<pre><code class="language-bash"># in normal world console
$ mount -a 
...
host on /root/shared type 9p (rw,sync,dirsync,relatime,access-client,trans=virtio)
</code></pre>
<p><strong>Explanation:</strong> automatic mount is done by the following line in <code>/etc/fstab</code></p>
<pre><code class="language-bash"># in normal world console
$ cat /etc/fstab | tail -n 1
host    /root/shared 9p trans=virtio 0 0
</code></pre>
<p>which is done by add that file to the overlay filesystem <code>${OPTEE}/build/br-ext/board/qemu/overlay/etc/fstab</code></p>
<p>Should you want to mount manually, do <code>mkdir shared &amp;&amp; mount -t 9p -o trans=virtio host shared</code></p>
<p><strong>1. To rebuild a CA:</strong> Every time we rebuild a CA (see the command above <code>make buildroot...</code>), copy its binary to the shared directory: </p>
<pre><code class="language-bash">$ cp ./out-br/target/usr/bin/optee_example_hello_world build/shared_folder/
</code></pre>
<p><strong>2. To rebuilt a TA:</strong> If we rebuild a TA, first copy TAs to the shared directory (similar to above); then in the normal world console, copy the TAs to the guest's <code>/lib</code> where OPTEE's daemon will look for TAs: </p>
<pre><code class="language-sh"># (in the normal world console) 
$ cd shared &amp;&amp; cp *.ta /lib/optee_armtz/
</code></pre>
<p>You are recommended to write a script to automate the above workflow. </p>
<p>(Optional) Need extra software packages (e.g. strace) to be included in the rootfs image? Change <code>build/common.mk</code>. To see what packages are available &amp; selected, check out file <code>out-br/.config</code>. See <a href="https://github.com/OP-TEE/optee_os/issues/2632">here</a>. </p>
<h3 id="choice-3-rpi3-copying-files-over-ssh">Choice 3: Rpi3 - copying files over SSH</h3>
<p>If we are running Rpi3, we copy over CA/TA over SSH connection. <a href="https://github.com/piachristel/open-source-fabric-optee-chaincode/blob/master/documentation/chaincode-and-chaincode-proxy-rapi.md">This article</a> explains how to quickly configure an SSH server on Rpi3. </p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs"], "search": "../../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.51d95adb.min.js"></script>
      
    
  </body>
</html>